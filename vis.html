<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVision Max - Cargando</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000, #000000, #000000);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: white;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .splash-container {
            text-align: center;
            z-index: 10;
            position: relative;
            max-width: 800px;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 1.5s ease forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .floating-image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            animation: float 6s ease-in-out infinite;
            border: 8px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .floating-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes float {
            0% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(2deg);
            }
            100% {
                transform: translateY(0px) rotate(0deg);
            }
        }

        h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            font-weight: 700;
            background: linear-gradient(90deg, #00FF88, #FF2A6D, #00D9FF);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }

        .tagline {
            font-size: 1.5rem;
            margin-bottom: 30px;
            font-weight: 300;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }

        .description {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 30px;
            line-height: 1.6;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }

        .features {
            text-align: left;
            max-width: 500px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .features h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #00FF88;
        }

        .features ul {
            list-style-type: none;
        }

        .features li {
            padding: 8px 0;
            position: relative;
            padding-left: 25px;
        }

        .features li:before {
            content: "•";
            color: #00FF88;
            font-size: 1.5rem;
            position: absolute;
            left: 0;
            top: 3px;
        }

        .final-message {
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 20px;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }

        .slogan {
            font-size: 1.1rem;
            font-style: italic;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: particle-float 15s infinite linear;
        }

        @keyframes particle-float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .glow {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            filter: blur(20px);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 30px auto;
            overflow: hidden;
            position: relative;
        }

        .loading-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00FF88, #FF2A6D);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .loading-text {
            font-size: 0.9rem;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ================================================== */
        /* CONTENEDOR DE LA APLICACIÓN - OCULTO INICIALMENTE */
        /* ================================================== */
        #app-container {
            display: none;
            width: 100%;
            height: 100vh;
        }
        /* ================================================== */
    </style>
</head>
<body>
    <!-- EFECTO DE PRESENTACIÓN -->
    <div class="particles" id="particles"></div>
    <div class="glow"></div>
    
    <div class="splash-container" id="splash-container">
        <div class="floating-image">
            <img src="https://i.ibb.co/p6zkdWdb/1000210170.png" alt="TVision Max">
        </div>
        <h1>TVision Max</h1>
        <div class="tagline">Donde cada detalle cobra vida</div>
        <div class="description">
            Experimenta la televisión como nunca antes. TVision Max te ofrece una calidad de imagen excepcional y una claridad que redefine el entretenimiento.
        </div>
        
        <div class="features">
            <h3>✨ Características principales:</h3>
            <ul>
                <li>Calidad Max: Imágenes nítidas y colores vibrantes</li>
                <li>Interfaz intuitiva: Navegación fácil y fluida</li>
                <li>Contenido ilimitado: Todo tu entretenimiento en un solo lugar</li>
                <li>Streaming sin interrupciones: Disfruta sin límites</li>
            </ul>
        </div>
        
        <div class="final-message">
            La evolución de la televisión está aquí.
        </div>
        <div class="slogan">
            TVision Max - Máxima calidad, máxima experiencia.
        </div>
        
        <div class="loading-bar">
            <div class="loading-progress" id="loading-progress"></div>
        </div>
        <div class="loading-text" id="loading-text">Inicializando TVision Max...</div>
    </div>

    <!-- ================================================== -->
    <!-- AQUÍ DEBES PEGAR TODA TU APLICACIÓN HTML COMPLETA -->
    <!-- ================================================== -->
    <div id="app-container">
        <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisiónMáx - Reproductor IPTV Premium</title>
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        :root {
            /* PALETA DE COLORES AMOLED OPTIMIZADA */
            --primary-bg: #000000;           /* Negro puro AMOLED */
            --secondary-bg: #0A0A0A;         /* Negro casi puro */
            --accent-color: #00FF88;         /* Verde neón vibrante */
            --accent-secondary: #FF2A6D;     /* Rosa neón para contraste */
            --accent-tertiary: #00D9FF;      /* Azul neón para detalles */
            --text-color: #FFFFFF;           /* Texto blanco puro */
            --text-secondary: #AAAAAA;       /* Texto secundario */
            --card-bg: #111111;              /* Fondo de tarjetas */
            --card-hover: #1A1A1A;           /* Hover de tarjetas */
            --highlight: #FF2A6D;            /* Destacados */
            --progress-bg: #222222;          /* Fondo de barras de progreso */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }
        
        /* Header con gradiente neón */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-container img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary)) padding-box,
                        linear-gradient(135deg, var(--accent-color), var(--accent-secondary)) border-box;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }
        
        .logo-container h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary), var(--accent-tertiary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            letter-spacing: 0.5px;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .settings-btn:hover {
            transform: scale(1.1);
            color: var(--accent-color);
        }
        
        /* Player View */
        #player-view {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: var(--primary-bg);
            overflow: hidden;
        }
        
        /* Reproductor Inteligente Mejorado con Plyr */
        #player-wrapper {
            width: 100%;
            background-color: #000;
            position: relative;
            flex-shrink: 0;
        }
        
        #channel-player {
            width: 100%;
            height: auto;
            background: black;
            display: block;
            object-fit: contain;
        }
        
        /* Ajustes para Plyr con tema AMOLED */
        .plyr {
            --plyr-color-main: var(--accent-color);
            --plyr-control-icon-size: 18px;
            --plyr-control-spacing: 10px;
            --plyr-control-radius: 8px;
            --plyr-video-controls-background: linear-gradient(transparent, rgba(0,0,0,0.9));
            --plyr-video-control-color: white;
            --plyr-audio-controls-background: var(--secondary-bg);
            --plyr-audio-control-color: var(--text-color);
            border-radius: 0;
        }
        
        .plyr__controls {
            background: linear-gradient(transparent, rgba(0,0,0,0.9)) !important;
        }
        
        .plyr__control--overlaid {
            background: var(--accent-color) !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.7);
        }
        
        .plyr__control:hover {
            background: var(--accent-color) !important;
        }
        
        .plyr__progress__buffer {
            background: rgba(255,255,255,0.1) !important;
        }
        
        /* NUEVO: Panel de estadísticas técnicas - OCULTO PERO FUNCIONAL */
        .tech-stats-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            display: none;
            z-index: 60;
            max-width: 280px;
            backdrop-filter: blur(10px);
        }
        
        .tech-stats-panel.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .tech-stats-panel h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            padding-bottom: 5px;
        }
        
        .tech-stats-panel div {
            font-size: 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .tech-stats-panel .stat-value {
            color: var(--accent-tertiary);
            font-weight: bold;
        }
        
        /* NUEVO: Controles gestuales visuales */
        .gesture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            pointer-events: none;
        }
        
        .gesture-feedback {
            background: rgba(0,0,0,0.8);
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid var(--accent-color);
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        
        /* Indicadores de estado inteligente */
        .player-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            z-index: 50;
            border: 1px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .player-status.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* NOTIFICACIÓN DE SIGUIENTE EPISODIO */
        .next-episode-notification {
            position: absolute;
            bottom: 80px;
            right: 15px;
            background: rgba(10,10,10,0.95);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-color);
            display: none;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
            z-index: 60;
            font-size: 0.9em;
            box-shadow: 0 5px 25px rgba(0,0,0,0.7);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .next-episode-notification.show {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .next-episode-info {
            font-size: 14px;
            color: white;
        }
        
        .next-episode-actions {
            display: flex;
            gap: 10px;
        }
        
        .notification-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            flex: 1;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .play-next-btn {
            background: var(--accent-color);
            color: #000;
        }
        
        .play-next-btn:hover {
            background: #00e077;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }
        
        .cancel-next-btn {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .cancel-next-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Search Bar in Player View - REGRESADO AL DISEÑO ORIGINAL */
        #player-search-bar {
            padding: 12px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            gap: 10px;
            flex-shrink: 0;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        #player-search-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #player-search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        #back-to-main {
            background-color: var(--highlight);
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            padding: 10px 15px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        #back-to-main:hover {
            background: #ff1a5e;
            transform: translateY(-2px);
        }
        
        #global-search-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            border: none;
            border-radius: 8px;
            color: #000;
            padding: 10px 15px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        #global-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }
        
        /* BOTÓN DE ESTADÍSTICAS OCULTO - PERO FUNCIONAL */
        #tech-stats-btn {
            display: none; /* OCULTO PERO FUNCIONAL */
        }
        
        /* Series Controls */
        #series-controls {
            background: var(--secondary-bg);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
            max-height: 35vh;
            overflow-y: auto;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .series-info-display {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary), var(--accent-tertiary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        .auto-play-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .auto-play-toggle {
            transform: scale(1.2);
            accent-color: var(--accent-color);
        }
        
        .auto-play-label {
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Temporadas Container */
        .seasons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .seasons-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .seasons-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 8px 0;
            scrollbar-width: thin;
        }
        
        .seasons-scroll::-webkit-scrollbar {
            height: 4px;
        }
        
        .seasons-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        
        .season-btn {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            min-width: 110px;
            flex-shrink: 0;
            white-space: nowrap;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .season-btn:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .season-btn.active {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            color: #000;
            border-color: transparent;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }
        
        /* Episodios Container */
        .episodes-container {
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        
        .episodes-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .episodes-scroll {
            display: flex;
            overflow-x: auto;
            gap: 6px;
            padding: 8px 0;
            scrollbar-width: thin;
        }
        
        .episodes-scroll::-webkit-scrollbar {
            height: 4px;
        }
        
        .episodes-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        
        .episode-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            min-width: 50px;
            flex-shrink: 0;
            white-space: nowrap;
            border: 2px solid transparent;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .episode-item:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .episode-item.current {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            color: #000;
            border-color: transparent;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }
        
        /* Otras Series Container */
        .other-series-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .other-series-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        
        .other-series-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 8px 0;
            scrollbar-width: thin;
        }
        
        .other-series-scroll::-webkit-scrollbar {
            height: 4px;
        }
        
        .other-series-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 4px;
        }
        
        .other-series-item {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .other-series-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
            border-color: var(--accent-color);
        }
        
        .other-series-name {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 2.6em;
            line-height: 1.3;
        }
        
        .other-series-info {
            font-size: 11px;
            color: var(--accent-color);
        }

        /* Channels in Player View */
        #player-channels-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--primary-bg);
            min-height: 300px;
            max-height: 40vh;
        }
        
        /* Main Content */
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }
        
        /* Categories Panel */
        #categories-panel {
            width: 30%;
            background-color: var(--secondary-bg);
            overflow-y: auto;
            border-right: 1px solid rgba(0, 255, 136, 0.2);
            flex-shrink: 0;
        }
        
        .category-item {
            padding: 15px 18px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .category-item:hover {
            background-color: rgba(0, 255, 136, 0.1);
            padding-left: 22px;
        }
        
        .category-item.active {
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.15), transparent);
            color: var(--text-color);
            border-left: 3px solid var(--accent-color);
            padding-left: 22px;
        }
        
        .category-name {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 14px;
            font-weight: 500;
        }
        
        .category-count {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            color: #000;
            border-radius: 12px;
            padding: 3px 10px;
            font-size: 12px;
            min-width: 28px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Channels Panel */
        #channels-panel {
            width: 70%;
            background-color: var(--primary-bg);
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        /* Search Bar in Main View */
        #search-bar {
            padding: 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            flex-shrink: 0;
        }
        
        #search-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #search-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        /* Canales normales - 3 columnas compactas */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            padding: 0;
        }
        
        .channel-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 110px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .channel-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            border-color: var(--accent-color);
        }
        
        /* Estilo para canal activo/reproduciéndose */
        .channel-card.active {
            background: var(--card-bg);
            border: 2px solid var(--accent-color);
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .channel-card.active .channel-name {
            color: var(--text-color);
            font-weight: bold;
        }

        .channel-card.active .favorite-star {
            color: var(--text-color);
        }

        /* Para canales especiales activos */
        .special-channel-card.active {
            background: var(--card-bg);
            border: 2px solid var(--accent-color);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .special-channel-card.active .special-channel-name {
            color: var(--text-color);
            font-weight: bold;
        }

        /* Indicador de reproducción en tiempo real */
        .playing-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            z-index: 4;
            box-shadow: 0 0 10px #ff4444;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0.8); opacity: 1; }
        }
        
        .channel-card img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 8px;
            flex-shrink: 0;
            object-fit: container;
        }
        
        .channel-name {
            font-size: 8px;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
            line-height: 1.3;
            font-weight: 500;
        }
        
        /* Canales especiales (películas, series, dramas) - 3 columnas con imagen completa */
        .special-channels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            padding: 0;
        }
        
        .special-channel-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
            aspect-ratio: 2/3;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .special-channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
            border-color: var(--accent-color);
        }
        
        .special-channel-card img {
            width: 100%;
            height: 85%;
            object-fit: container;
            flex-shrink: 0;
        }
        
        .special-channel-name {
            height: 15%;
            padding: 10px 6px;
            font-size: 8px;
            color: var(--text-color);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(17, 17, 17, 0.9);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
            font-weight: 500;
        }
        
        .favorite-star {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
            color: gold;
            cursor: pointer;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .favorite-star:hover {
            transform: scale(1.2);
        }
        
        .favorite-star.inactive {
            color: #555;
        }
        
        /* Series Info */
        .series-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 5px;
            font-size: 11px;
            color: white;
            display: none;
        }
        
        .channel-card:hover .series-info {
            display: block;
        }
        
        .series-progress {
            height: 3px;
            background: #333;
            margin-top: 3px;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .series-progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 2px;
            width: 0%;
        }
        
        /* Settings Menu */
        #settings-menu {
            position: absolute;
            top: 70px;
            right: 15px;
            background-color: var(--secondary-bg);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 10px 0;
            display: none;
            z-index: 200;
            min-width: 220px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }
        
        .settings-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-item:hover {
            background-color: rgba(0, 255, 136, 0.1);
            padding-left: 20px;
        }
        
        /* Modal de búsqueda global */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 30px;
        }
        
        .search-modal-content {
            background-color: var(--secondary-bg);
            width: 90%;
            max-width: 650px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .search-modal-header {
            padding: 18px 20px;
            background-color: var(--primary-bg);
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .search-modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-modal-close:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .search-modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .search-modal-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .search-modal-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .search-result-item {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .search-result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            border-color: var(--accent-color);
        }
        
        .search-result-name {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .search-result-category {
            font-size: 13px;
            color: var(--accent-color);
        }
        
        /* Indicador de carga inteligente */
        .smart-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: transparent;
            z-index: 10000;
            display: none;
        }
        
        .smart-loading-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .cache-status {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--accent-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        /* ESTILOS PARA PANTALLA COMPLETA HORIZONTAL */
        .plyr--fullscreen {
            background: #000 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
        }

        .plyr--fullscreen .plyr__video-wrapper {
            width: 100% !important;
            height: 100% !important;
        }

        .plyr--fullscreen video {
            object-fit: contain !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Ocultar elementos en pantalla completa */
        .plyr--fullscreen #player-search-bar,
        .plyr--fullscreen #series-controls,
        .plyr--fullscreen #player-channels-container,
        .plyr--fullscreen #header {
            display: none !important;
        }

        /* Para móviles en landscape */
        @media (max-width: 768px) and (orientation: landscape) {
            .plyr--fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #main-content {
                flex-direction: column;
            }
            
            #categories-panel {
                width: 100%;
                max-height: 30vh;
            }
            
            #channels-panel {
                width: 100%;
            }
            
            .channels-grid,
            .special-channels-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .channel-card {
                height: 100px;
                padding: 10px;
            }
            
            .channel-card img {
                width: 35px;
                height: 35px;
                margin-bottom: 6px;
            }
            
            .channel-name {
                font-size: 9px;
            }
            
            .special-channel-name {
                font-size: 9px;
                padding: 8px 5px;
            }
            
            .category-name {
                font-size: 14px;
            }
            
            .season-btn {
                min-width: 100px;
                padding: 8px 12px;
            }
            
            .episode-item {
                min-width: 45px;
                padding: 7px 10px;
                font-size: 11px;
            }
            
            .other-series-item {
                min-width: 120px;
                padding: 10px;
            }
            
            .other-series-name {
                font-size: 12px;
            }
            
            .search-results-grid {
                grid-template-columns: 1fr;
            }
            
            #player-search-bar {
                flex-wrap: wrap;
            }
            
            #player-search-input {
                min-width: 150px;
            }
            
            /* Ajustes para más espacio en móvil */
            #player-channels-container {
                padding: 12px;
                min-height: 280px;
            }
        }
        
        @media (max-width: 480px) {
            .channels-grid,
            .special-channels-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .channel-card {
                height: 95px;
                padding: 8px;
            }
            
            .channel-card img {
                width: 30px;
                height: 30px;
                margin-bottom: 5px;
            }
            
            .channel-name {
                font-size: 10px;
            }
            
            .special-channel-name {
                font-size: 10px;
                padding: 6px 4px;
            }
            
            .category-name {
                font-size: 13px;
            }
            
            .season-btn {
                min-width: 90px;
                padding: 7px 10px;
                font-size: 12px;
            }
            
            .episode-item {
                min-width: 40px;
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .other-series-item {
                min-width: 110px;
                padding: 8px;
            }
            
            .other-series-name {
                font-size: 11px;
            }
            
            #player-search-bar {
                padding: 10px 12px;
            }
            
            #player-search-input {
                font-size: 13px;
                padding: 8px;
            }
            
            #back-to-main, #global-search-btn {
                font-size: 13px;
                padding: 8px 12px;
            }
            
            /* Ajustes para más espacio en móvil pequeño */
            #player-channels-container {
                padding: 10px;
                min-height: 260px;
            }
        }

        /* VERSIÓN ESPECÍFICA - Solo tocar lo necesario */
        #player-channels-container {
            flex: 1 !important;
            max-height: none !important;
            min-height: auto;
        }

        #channel-player {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }
/* SOLUCIÓN SIMPLE - Solo CSS */
#player-search-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: nowrap;
    justify-content: space-between;
}

#player-search-input {
    flex: 1;
    min-width: 150px;
}

#back-to-main, #global-search-btn {
    white-space: nowrap;
    flex-shrink: 0;
}

/* Para pantallas muy pequeñas */
@media (max-width: 380px) {
    #player-search-bar {
        flex-wrap: wrap;
    }
    
    #player-search-input {
        min-width: 100px;
    }
    
    #back-to-main, #global-search-btn {
        font-size: 12px;
        padding: 8px 10px;
    }
}
/* SOLUCIÓN: El MENÚ COMPLETO no se mueve horizontalmente */
#series-controls {
    overflow-x: hidden !important;  /* El menú completo NO se mueve horizontalmente */
    overflow-y: auto !important;    /* El menú completo SÍ se mueve verticalmente */
    max-height: 35vh;
}

/* Las secciones DENTRO del menú SÍ se mueven horizontalmente */
.seasons-scroll, .episodes-scroll, .other-series-scroll {
    display: flex;
    overflow-x: auto !important;    /* Cada sección SÍ se mueve horizontalmente */
    overflow-y: hidden !important;  /* Cada sección NO se mueve verticalmente */
    gap: 8px;
    padding: 8px 0;
    scrollbar-width: thin;
}

/* Mantener las barras de scroll horizontales para cada sección */
.seasons-scroll::-webkit-scrollbar,
.episodes-scroll::-webkit-scrollbar,
.other-series-scroll::-webkit-scrollbar {
    height: 4px;
}

.seasons-scroll::-webkit-scrollbar-thumb,
.episodes-scroll::-webkit-scrollbar-thumb,
.other-series-scroll::-webkit-scrollbar-thumb {
    background-color: var(--accent-color);
    border-radius: 4px;
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Plyr JS -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
</head>
<body>
    <!-- Indicador de carga inteligente -->
    <div class="smart-loading-indicator" id="smart-loading-indicator">
        <div class="smart-loading-bar" id="smart-loading-bar"></div>
    </div>
    
    <!-- Estado del cache -->
    <div class="cache-status" id="cache-status"></div>
    
    <div class="app-container">
        <!-- Header -->
        <div id="header">
            <div class="logo-container">
                <img src="https://i.ibb.co/p6zkdWdb/1000210170.png" alt="Death Star">
                <h1> 𝑻𝑽𝒊𝒔𝒊𝒐𝒏 𝑴𝒂𝒙 </h1>
            </div>
            <button class="settings-btn" id="settings-btn">⚙️</button>
            <div id="settings-menu">
                <div class="settings-item" id="show-favorites">⭐ Ver Favoritos</div>
                <div class="settings-item" id="refresh-list">🔄 Actualizar Lista</div>
                <div class="settings-item" id="load-m3u">📁 Cargar archivo M3U</div>
                <div class="settings-item" id="clear-cache">🗑️ Limpiar Cache</div>
                <div class="settings-item" id="close-settings">❌ Cerrar</div>
            </div>
        </div>

        <!-- Player View (se muestra cuando se reproduce un canal) -->
        <div id="player-view">
            <!-- Player Wrapper - MEJORADO CON PLYR -->
            <div id="player-wrapper">
                <video id="channel-player" autoplay playsinline></video>
                
                <!-- NUEVO: Panel de estadísticas técnicas - OCULTO PERO FUNCIONAL -->
                <div class="tech-stats-panel" id="tech-stats-panel">
                    <h4>📊 Estadísticas Técnicas</h4>
                    <div>Resolución: <span class="stat-value" id="stat-resolution">-</span></div>
                    <div>Bitrate: <span class="stat-value" id="stat-bitrate">-</span></div>
                    <div>Buffer: <span class="stat-value" id="stat-buffer">-</span></div>
                    <div>FPS: <span class="stat-value" id="stat-fps">-</span></div>
                    <div>Codec: <span class="stat-value" id="stat-codec">-</span></div>
                </div>
                
                <!-- NUEVO: Overlay para controles gestuales -->
                <div class="gesture-overlay" id="gesture-overlay">
                    <div class="gesture-feedback" id="gesture-feedback">
                        <span id="gesture-icon">⏩</span>
                        <span id="gesture-text">+10s</span>
                    </div>
                </div>
                
                <!-- Indicador de estado -->
                <div class="player-status" id="player-status">
                    <div class="loading-spinner"></div>
                    <span id="status-text">Cargando...</span>
                </div>
                
                <!-- Notificación de siguiente episodio - MODIFICADA -->
                <div class="next-episode-notification" id="next-episode-notification">
                    <div class="next-episode-info" id="next-episode-info">
                        Siguiente episodio en 10 segundos
                    </div>
                    <div class="next-episode-actions">
                        <button class="notification-btn play-next-btn" id="play-next-now">Reproducir ahora</button>
                        <button class="notification-btn cancel-next-btn" id="cancel-next">Cancelar</button>
                    </div>
                </div>
            </div>
            
            <!-- Search Bar in Player View - REGRESADO AL DISEÑO ORIGINAL -->
            <div id="player-search-bar">
                <input type="text" id="player-search-input" placeholder="Buscar en esta categoría...">
                <button id="back-to-main">← Volver</button>
                <!-- BOTÓN OCULTO PERO FUNCIONAL -->
                <button id="tech-stats-btn" style="display: none;">📊 Stats</button>
                <button id="global-search-btn">🔍 Global</button>
            </div>
            
            <!-- Series Controls -->
            <div id="series-controls">
                <div id="series-info-display" class="series-info-display">Ojo de Halcón S01 E01</div>
                <div class="auto-play-controls">
                    <input type="checkbox" id="auto-play-toggle" class="auto-play-toggle" checked>
                    <label for="auto-play-toggle" class="auto-play-label">Reproducción automática inteligente</label>
                </div>
                
                <!-- Temporadas -->
                <div id="seasons-container" class="seasons-container" style="display:none;">
                    <div class="seasons-title">📺 Temporadas Disponibles</div>
                    <div id="seasons-scroll" class="seasons-scroll">
                        <!-- Las temporadas se cargarán aquí dinámicamente -->
                    </div>
                </div>
                
                <!-- Episodios -->
                <div id="episodes-container" class="episodes-container" style="display:none;">
                    <div class="episodes-title">🎬 Episodios de la Temporada</div>
                    <div id="episodes-scroll" class="episodes-scroll">
                        <!-- Los episodios se cargarán aquí dinámicamente -->
                    </div>
                </div>
                
                <!-- Otras Series -->
                <div id="other-series-container" class="other-series-container" style="display:none;">
                    <div class="other-series-title">🌟 Series que te pueden gustar</div>
                    <div id="other-series-scroll" class="other-series-scroll">
                        <!-- Otras series se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Channels in Player View - MEJORADO CON MÁS ESPACIO -->
            <div id="player-channels-container">
                <div class="channels-grid" id="player-channels-grid">
                    <!-- Los canales de la categoría actual se cargarán aquí -->
                </div>
            </div>
        </div>

        <!-- Main Content (vista principal) -->
        <div id="main-content">
            <!-- Categories Panel -->
            <div id="categories-panel">
                <!-- Categories will be loaded dynamically -->
            </div>

            <!-- Channels Panel -->
            <div id="channels-panel">
                <!-- Search Bar in Main View -->
                <div id="search-bar">
                    <input type="text" id="search-input" placeholder="Buscar canal...">
                </div>
                
                <!-- Channels Grid -->
                <div id="channels-grid-container">
                    <!-- Channels will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Búsqueda Global -->
    <div id="global-search-modal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <div class="search-modal-title">🔍 Búsqueda Global</div>
                <button class="search-modal-close" id="close-global-search">✕</button>
            </div>
            <div class="search-modal-body">
                <input type="text" id="global-search-input" class="search-modal-input" placeholder="Buscar en todos los canales, series y categorías...">
                <div id="global-search-results" class="search-results-grid">
                    <!-- Los resultados de búsqueda se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".m3u,.m3u8,.txt" style="display:none">

    <script>
        // ===== SISTEMA DE REPRODUCCIÓN INTELIGENTE MEJORADO CON CONTROLES AVANZADOS =====
        class SmartVideoPlayer {
            constructor(videoElement) {
                this.video = videoElement;
                this.hls = null;
                this.currentUrl = null;
                this.isPlaying = false;
                this.currentTime = 0;
                this.duration = 0;
                this.playbackPositions = new Map();
                this.retryCount = 0;
                this.maxRetries = 3;
                this.nextEpisodeTimer = null;
                this.autoPlayEnabled = true;
                this.nextEpisodeNotificationShown = false;
                this.plyr = null;
                this.techStatsVisible = false;
                this.frameCount = 0;
                this.lastFpsTime = 0;
                this.currentFps = 0;
                
                // Elementos de UI
                this.playerStatus = document.getElementById('player-status');
                this.statusText = document.getElementById('status-text');
                this.nextEpisodeNotification = document.getElementById('next-episode-notification');
                this.nextEpisodeInfo = document.getElementById('next-episode-info');
                this.playNextNowBtn = document.getElementById('play-next-now');
                this.cancelNextBtn = document.getElementById('cancel-next');
                this.techStatsPanel = document.getElementById('tech-stats-panel');
                this.gestureOverlay = document.getElementById('gesture-overlay');
                this.gestureFeedback = document.getElementById('gesture-feedback');
                this.gestureIcon = document.getElementById('gesture-icon');
                this.gestureText = document.getElementById('gesture-text');
                
                this.initializePlyr();
                this.setupEventListeners();
                this.setupGestureControls();
                this.startStatsUpdate();
                this.setupHiddenControls(); // NUEVO: Configurar controles ocultos
            }
            
            // NUEVO: Configurar controles ocultos pero funcionales
            setupHiddenControls() {
                // Las estadísticas se activan con doble tap en la pantalla
                let lastTap = 0;
                this.video.addEventListener('touchstart', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    
                    if (tapLength < 500 && tapLength > 0) {
                        // Doble tap detectado - alternar estadísticas
                        this.toggleTechStats();
                    }
                    lastTap = currentTime;
                });
                
                // También se puede activar con click derecho (en desktop)
                this.video.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.toggleTechStats();
                });
            }
            
            initializePlyr() {
                // Ocultar controles nativos del video
                this.video.controls = false;
                
                // Inicializar Plyr CON CONTROLES AVANZADOS
                this.plyr = new Plyr(this.video, {
                    controls: [
                        'play-large',
                        'play',
                        'progress',
                        'current-time',
                        'duration',
                        'mute',
                        'volume',
                        'captions',
                        'settings',
                        'pip',
                        'fullscreen'
                    ],
                    settings: ['quality', 'speed', 'captions'],
                    quality: {
                        default: 0,
                        options: [4320, 2160, 1440, 1080, 720, 576, 480, 360, 240],
                        forced: true,
                        onChange: (quality) => {
                            console.log('Calidad cambiada:', quality);
                            this.updateTechStats();
                        }
                    },
                    speed: {
                        selected: 1,
                        options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2]
                    },
                    invertTime: false,
                    tooltips: { controls: true, seek: true },
                    keyboard: { focused: true, global: true },
                    seekTime: 10,
                    volume: 0.8,
                    clickToPlay: true,
                    hideControls: true,
                    resetOnEnd: false
                });
                
                // CONFIGURACIÓN PARA PANTALLA COMPLETA HORIZONTAL
                this.setupFullscreenOrientation();
                
                // Personalizar Plyr para que coincida con tu tema
                this.customizePlyr();
            }
            
            // NUEVO: Configurar controles gestuales
            setupGestureControls() {
                let startX = 0;
                let startY = 0;
                let isGestureActive = false;
                let gestureType = null;

                this.video.addEventListener('touchstart', (e) => {
                    if (this.plyr.fullscreen.active) {
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        isGestureActive = true;
                    }
                });

                this.video.addEventListener('touchmove', (e) => {
                    if (!isGestureActive || !this.plyr.fullscreen.active) return;
                    
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = startX - currentX;
                    const diffY = startY - currentY;
                    
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        // Gestos horizontales - Buscar
                        gestureType = 'seek';
                        const seekAmount = Math.round(diffX / 10) * 5; // 5 segundos por gesto
                        this.showGestureFeedback(seekAmount > 0 ? '⏪' : '⏩', `${Math.abs(seekAmount)}s`);
                    } else {
                        // Gestos verticales - Volumen/Brillo
                        if (currentX < window.innerWidth / 2) {
                            // Lado izquierdo - Brillo
                            gestureType = 'brightness';
                            this.showGestureFeedback('☀️', `${diffY > 0 ? '-' : '+'} Brillo`);
                        } else {
                            // Lado derecho - Volumen
                            gestureType = 'volume';
                            this.showGestureFeedback('🔊', `${diffY > 0 ? '-' : '+'} Vol`);
                        }
                    }
                });

                this.video.addEventListener('touchend', (e) => {
                    if (!isGestureActive) return;
                    
                    const currentX = e.changedTouches[0].clientX;
                    const currentY = e.changedTouches[0].clientY;
                    const diffX = startX - currentX;
                    const diffY = startY - currentY;
                    
                    if (gestureType === 'seek') {
                        const seekTime = this.plyr.currentTime + (diffX > 0 ? -10 : 10);
                        this.plyr.currentTime = Math.max(0, Math.min(seekTime, this.plyr.duration));
                    }
                    
                    this.hideGestureFeedback();
                    isGestureActive = false;
                    gestureType = null;
                });
            }
            
            // NUEVO: Mostrar feedback de gestos
            showGestureFeedback(icon, text) {
                this.gestureIcon.textContent = icon;
                this.gestureText.textContent = text;
                this.gestureOverlay.style.display = 'flex';
            }
            
            // NUEVO: Ocultar feedback de gestos
            hideGestureFeedback() {
                setTimeout(() => {
                    this.gestureOverlay.style.display = 'none';
                }, 500);
            }
            
            // NUEVO: Sistema de estadísticas técnicas
            startStatsUpdate() {
                setInterval(() => {
                    if (this.techStatsVisible) {
                        this.updateTechStats();
                    }
                }, 1000);
                
                // Contador de FPS
                this.video.addEventListener('timeupdate', () => {
                    this.frameCount++;
                    const now = performance.now();
                    if (now - this.lastFpsTime >= 1000) {
                        this.currentFps = Math.round((this.frameCount * 1000) / (now - this.lastFpsTime));
                        this.frameCount = 0;
                        this.lastFpsTime = now;
                    }
                });
            }
            
            // NUEVO: Actualizar estadísticas técnicas
            updateTechStats() {
                if (!this.techStatsPanel) return;
                
                const resolution = this.video.videoWidth && this.video.videoHeight ? 
                    `${this.video.videoWidth}x${this.video.videoHeight}` : '-';
                
                const bitrate = this.hls && this.hls.levels && this.hls.levels[this.hls.currentLevel] ?
                    Math.round(this.hls.levels[this.hls.currentLevel].bitrate / 1000) + ' kbps' : '-';
                
                const buffer = this.video.buffered.length ? 
                    Math.round(this.video.buffered.end(this.video.buffered.length - 1) - this.video.currentTime) + 's' : '0s';
                
                const codec = this.video.canPlayType('video/mp4; codecs="avc1.42E01E"') ? 'H.264' : 
                             this.video.canPlayType('video/webm; codecs="vp8, vorbis"') ? 'VP8' : 'Unknown';
                
                document.getElementById('stat-resolution').textContent = resolution;
                document.getElementById('stat-bitrate').textContent = bitrate;
                document.getElementById('stat-buffer').textContent = buffer;
                document.getElementById('stat-fps').textContent = this.currentFps + ' fps';
                document.getElementById('stat-codec').textContent = codec;
            }
            
            // NUEVO: Alternar visibilidad de estadísticas
            toggleTechStats() {
                this.techStatsVisible = !this.techStatsVisible;
                if (this.techStatsVisible) {
                    this.techStatsPanel.classList.add('show');
                    this.updateTechStats();
                } else {
                    this.techStatsPanel.classList.remove('show');
                }
            }
            
            // Configurar orientación horizontal en pantalla completa
            setupFullscreenOrientation() {
                this.plyr.on('enterfullscreen', event => {
                    console.log('Entrando en pantalla completa - Forzando horizontal');
                    this.lockHorizontalOrientation();
                    this.hideUIElements();
                });
                
                this.plyr.on('exitfullscreen', event => {
                    console.log('Saliendo de pantalla completa');
                    this.unlockOrientation();
                    this.showUIElements();
                });
            }
            
            lockHorizontalOrientation() {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(error => {
                        console.log('No se pudo bloquear orientación:', error);
                        this.forceLandscapeWithCSS();
                    });
                } else {
                    this.forceLandscapeWithCSS();
                }
            }
            
            forceLandscapeWithCSS() {
                document.documentElement.classList.add('force-landscape');
                const landscapeStyle = document.createElement('style');
                landscapeStyle.id = 'landscape-style';
                landscapeStyle.textContent = `
                    .force-landscape body {
                        transform: rotate(90deg);
                        transform-origin: center center;
                        width: 100vh;
                        height: 100vw;
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        margin-top: -50vw;
                        margin-left: -50vh;
                        overflow: hidden;
                    }
                    .force-landscape .plyr--fullscreen {
                        transform: rotate(0deg) !important;
                    }
                `;
                document.head.appendChild(landscapeStyle);
            }
            
            unlockOrientation() {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
                document.documentElement.classList.remove('force-landscape');
                const landscapeStyle = document.getElementById('landscape-style');
                if (landscapeStyle) {
                    landscapeStyle.remove();
                }
            }
            
            hideUIElements() {
                const elementsToHide = [
                    '#player-search-bar',
                    '#series-controls',
                    '#player-channels-container',
                    '#header'
                ];
                
                elementsToHide.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                document.body.style.overflow = 'hidden';
            }
            
            showUIElements() {
                const elementsToShow = [
                    '#player-search-bar',
                    '#series-controls', 
                    '#player-channels-container',
                    '#header'
                ];
                
                elementsToShow.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = '';
                    }
                });
                
                document.body.style.overflow = '';
            }
            
            customizePlyr() {
                const style = document.createElement('style');
                style.textContent = `
                    .plyr--full-ui input[type="range"] {
                        color: var(--accent-color);
                    }
                    .plyr__control--overlaid {
                        background: var(--accent-color);
                    }
                    .plyr__control:hover {
                        background: var(--accent-color);
                    }
                    .plyr--video .plyr__controls {
                        background: linear-gradient(transparent, rgba(0,0,0,0.8));
                    }
                    .plyr__menu__container {
                        background: var(--secondary-bg);
                        border: 1px solid rgba(0, 255, 136, 0.3);
                    }
                    .plyr__menu__value {
                        color: var(--accent-color);
                    }
                `;
                document.head.appendChild(style);
            }
            
            setupEventListeners() {
                // Eventos del video
                this.video.addEventListener('loadedmetadata', () => {
                    this.duration = this.video.duration;
                    this.restorePlaybackPosition();
                    this.updateTechStats();
                });
                
                this.video.addEventListener('timeupdate', () => {
                    this.currentTime = this.video.currentTime;
                    this.checkForNextEpisode();
                    this.savePlaybackPosition();
                });
                
                this.video.addEventListener('waiting', () => {
                    this.showStatus('Buffering...');
                });
                
                this.video.addEventListener('playing', () => {
                    this.hideStatus();
                });
                
                this.video.addEventListener('ended', () => {
                    this.handleVideoEnded();
                });
                
                this.video.addEventListener('error', (e) => {
                    this.handleVideoError(e);
                });
                
                // Eventos de Plyr
                this.plyr.on('ready', () => {
                    console.log('Plyr está listo - Controles avanzados habilitados');
                });
                
                // Eventos de siguiente episodio
                this.playNextNowBtn.addEventListener('click', () => {
                    this.playNextEpisode();
                });
                
                this.cancelNextBtn.addEventListener('click', () => {
                    this.cancelNextEpisode();
                });
                
                // Detectar cambios de orientación
                window.addEventListener('orientationchange', () => {
                    this.handleOrientationChange();
                });
            }
            
            handleOrientationChange() {
                if (this.plyr.fullscreen.active) {
                    setTimeout(() => {
                        if (window.orientation === 90 || window.orientation === -90) {
                            console.log('En landscape - pantalla completa activa');
                        } else {
                            console.log('En portrait - forzar landscape');
                            this.lockHorizontalOrientation();
                        }
                    }, 100);
                }
            }
            
            // AGREGAR ESTA FUNCIÓN NUEVA PARA MANEJAR CALIDAD
            forceHighestQuality() {
                if (this.hls && this.hls.levels && this.hls.levels.length > 0) {
                    const levels = this.hls.levels;
                    let maxBitrate = 0;
                    let maxLevelIndex = -1;
                    
                    for (let i = 0; i < levels.length; i++) {
                        if (levels[i].bitrate > maxBitrate) {
                            maxBitrate = levels[i].bitrate;
                            maxLevelIndex = i;
                        }
                    }
                    
                    if (maxLevelIndex !== -1) {
                        this.hls.currentLevel = maxLevelIndex;
                        console.log(`Forzando calidad máxima: Nivel ${maxLevelIndex} (${Math.round(maxBitrate/1000)} kbps)`);
                    }
                }
            }
            
            // Reproducir URL con sistema inteligente mejorado
            play(url, channelInfo = null) {
                this.currentUrl = url;
                this.currentChannel = channelInfo;
                
                this.stop();
                this.showStatus('Cargando...');
                
                const finalUrl = transformUrlToM3u8(url);
                console.log('Reproduciendo URL inteligente:', finalUrl);
                
                const isHlsStream = finalUrl.toLowerCase().endsWith('.m3u8');
                
                if (isHlsStream) {
                    this.playHlsStream(finalUrl);
                } else {
                    this.playDirectStream(finalUrl);
                }
            }
            
            playHlsStream(url) {
                if (Hls.isSupported()) {
                    this.hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        startLevel: -1,
                        maxMaxBufferLength: 600,
                        maxBufferSize: 120 * 1000 * 1000,
                        maxBufferHole: 0.5,
                        highBufferWatchdogPeriod: 2,
                        nudgeOffset: 0.1,
                        nudgeMaxRetry: 3,
                        maxFragLookUpTolerance: 0.2,
                        liveSyncDurationCount: 3,
                        liveMaxLatencyDurationCount: 10,
                        liveDurationInfinity: false,
                        liveBackBufferLength: 0,
                        maxLiveSyncPlaybackRate: 1.1,
                        abrEwmaDefaultEstimate: 5000000,
                        abrEwmaSlowLive: 3.0,
                        abrEwmaFastLive: 1.0,
                        abrEwmaDefaultLive: 3.0,
                        abrEwmaSlowVoD: 3.0,
                        abrEwmaFastVoD: 1.0,
                        abrEwmaDefaultVoD: 3.0,
                        abrMaxWithRealBitrate: true,
                        maxStarvationDelay: 4,
                        maxLoadingDelay: 4,
                        minAutoBitrate: 0,
                        emeEnabled: true,
                        widevineLicenseUrl: ''
                    });
                    
                    this.hls.loadSource(url);
                    this.hls.attachMedia(this.video);
                    
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        const levels = this.hls.levels;
                        if (levels && levels.length > 0) {
                            let maxBitrate = 0;
                            let maxLevel = 0;
                            
                            levels.forEach((level, index) => {
                                if (level.bitrate > maxBitrate) {
                                    maxBitrate = level.bitrate;
                                    maxLevel = index;
                                }
                            });
                            
                            this.hls.nextLevel = maxLevel;
                            this.hls.currentLevel = maxLevel;
                            
                            console.log(`Calidad seleccionada: ${maxLevel} (${Math.round(maxBitrate/1000)} kbps)`);
                        }
                        
                        this.hideStatus();
                        this.video.play().catch(e => {
                            console.error('Error al reproducir:', e);
                            this.showStatus('Error de reproducción');
                        });
                    });
                    
                    this.hls.on(Hls.Events.MANIFEST_LOADED, () => {
                        console.log('Manifest cargado, forzando calidad máxima...');
                        setTimeout(() => {
                            this.forceHighestQuality();
                        }, 1000);
                    });
                    
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('Error HLS:', data);
                        this.handleHlsError(data);
                    });
                    
                    this.hls.on(Hls.Events.BUFFER_APPENDED, () => {
                        this.hideStatus();
                    });
                    
                } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
                    this.video.src = url;
                    this.video.play().catch(e => {
                        console.error('Error al reproducir:', e);
                        this.showStatus('Error de reproducción');
                    });
                } else {
                    this.showStatus('Formato no soportado');
                }
            }
            
            playDirectStream(url) {
                this.video.src = url;
                this.video.play().catch(e => {
                    console.error('Error al reproducir:', e);
                    this.showStatus('Error de reproducción');
                });
            }
            
            handleHlsError(data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            this.showStatus('Error de red, reintentando...');
                            this.retryPlayback();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            this.showStatus('Error de medio, recuperando...');
                            this.hls.recoverMediaError();
                            break;
                        default:
                            this.showStatus('Error fatal');
                            this.hls.destroy();
                            break;
                    }
                }
            }
            
            handleVideoError(e) {
                console.error('Error de video:', e);
                this.showStatus('Error de reproducción');
                this.retryPlayback();
            }
            
            retryPlayback() {
                if (this.retryCount < this.maxRetries) {
                    this.retryCount++;
                    this.showStatus(`Reintentando... (${this.retryCount}/${this.maxRetries})`);
                    
                    setTimeout(() => {
                        if (this.currentUrl) {
                            this.play(this.currentUrl, this.currentChannel);
                        }
                    }, 2000 * this.retryCount);
                } else {
                    this.showStatus('Error: No se puede reproducir');
                }
            }
            
            savePlaybackPosition() {
                if (this.currentUrl && this.video.duration > 0) {
                    const position = this.video.currentTime;
                    const percent = (position / this.video.duration) * 100;
                    
                    if (position > 10 && percent < 95) {
                        this.playbackPositions.set(this.currentUrl, {
                            time: position,
                            timestamp: Date.now()
                        });
                        
                        if (this.currentChannel && this.currentChannel.seriesInfo) {
                            updateSeriesProgress(
                                this.currentChannel.seriesInfo.seriesName,
                                this.currentChannel.seriesInfo.season,
                                this.currentChannel.seriesInfo.episode,
                                percent / 100
                            );
                        }
                    }
                }
            }
            
            restorePlaybackPosition() {
                if (this.currentUrl && this.playbackPositions.has(this.currentUrl)) {
                    const saved = this.playbackPositions.get(this.currentUrl);
                    const currentTime = Date.now();
                    const timeDiff = currentTime - saved.timestamp;
                    
                    if (timeDiff < 24 * 60 * 60 * 1000) {
                        this.video.currentTime = saved.time;
                        console.log(`Posición restaurada: ${Math.round(saved.time)}s`);
                    }
                }
            }
            
            checkForNextEpisode() {
                if (!this.currentChannel || !this.currentChannel.seriesInfo) return;
                
                const timeLeft = this.video.duration - this.video.currentTime;
                
                if (timeLeft <= 5 && this.autoPlayEnabled && !this.nextEpisodeTimer) {
                    this.playNextEpisode();
                }
            }
            
            playNextEpisode() {
                const nextEpisode = findNextEpisode(this.currentChannel);
                if (nextEpisode) {
                    this.cancelNextEpisode();
                    playSeries(nextEpisode);
                }
            }
            
            cancelNextEpisode() {
                if (this.nextEpisodeTimer) {
                    clearTimeout(this.nextEpisodeTimer);
                    this.nextEpisodeTimer = null;
                }
                this.nextEpisodeNotification.classList.remove('show');
                this.nextEpisodeNotificationShown = false;
            }
            
            handleVideoEnded() {
                if (this.autoPlayEnabled) {
                    this.playNextEpisode();
                }
            }
            
            showStatus(message) {
                this.statusText.textContent = message;
                this.playerStatus.classList.add('show');
            }
            
            hideStatus() {
                this.playerStatus.classList.remove('show');
                this.retryCount = 0;
            }
            
            stop() {
                this.cancelNextEpisode();
                
                if (this.hls) {
                    this.hls.destroy();
                    this.hls = null;
                }
                
                this.video.pause();
                this.video.removeAttribute('src');
                this.video.load();
                
                this.hideStatus();
                this.techStatsPanel.classList.remove('show');
                this.techStatsVisible = false;
            }
            
            setAutoPlay(enabled) {
                this.autoPlayEnabled = enabled;
            }
        }

        // ===== EL RESTO DEL CÓDIGO SE MANTIENE IGUAL =====
        // (Sistemas de cache, búsqueda, renderizado, etc.)
        
        // Solo cambiamos la parte del botón para que esté oculto
        // pero todas las funciones avanzadas siguen trabajando

        // ===== SISTEMA DE CACHE INTELIGENTE =====
        class SmartCacheManager {
            constructor() {
                this.cacheVersion = 'v2.0';
                this.cacheKey = 'iptv_smart_cache';
                this.lastUpdateKey = 'iptv_last_update';
                this.cacheExpiry = 24 * 60 * 60 * 1000;
                this.isUpdating = false;
            }
            
            hasValidCache() {
                try {
                    const cachedData = localStorage.getItem(this.cacheKey);
                    const lastUpdate = localStorage.getItem(this.lastUpdateKey);
                    
                    if (!cachedData || !lastUpdate) {
                        return false;
                    }
                    
                    const timeSinceUpdate = Date.now() - parseInt(lastUpdate);
                    return timeSinceUpdate < this.cacheExpiry;
                } catch (e) {
                    console.error('Error verificando cache:', e);
                    return false;
                }
            }
            
            loadFromCache() {
                try {
                    const cachedData = localStorage.getItem(this.cacheKey);
                    if (cachedData) {
                        return JSON.parse(cachedData);
                    }
                } catch (e) {
                    console.error('Error cargando desde cache:', e);
                }
                return null;
            }
            
            saveToCache(data) {
                try {
                    localStorage.setItem(this.cacheKey, JSON.stringify(data));
                    localStorage.setItem(this.lastUpdateKey, Date.now().toString());
                    console.log('Datos guardados en cache');
                    return true;
                } catch (e) {
                    console.error('Error guardando en cache:', e);
                    return false;
                }
            }
            
            clearCache() {
                try {
                    localStorage.removeItem(this.cacheKey);
                    localStorage.removeItem(this.lastUpdateKey);
                    console.log('Cache limpiado silenciosamente');
                    return true;
                } catch (e) {
                    console.error('Error limpiando cache:', e);
                    return false;
                }
            }
            
            getCacheStatus() {
                const hasCache = this.hasValidCache();
                const lastUpdate = localStorage.getItem(this.lastUpdateKey);
                const lastUpdateTime = lastUpdate ? new Date(parseInt(lastUpdate)).toLocaleTimeString() : 'Nunca';
                
                return {
                    hasCache,
                    lastUpdate: lastUpdateTime,
                    isUpdating: this.isUpdating
                };
            }
        }

        // ===== SISTEMA DE CARGA INTELIGENTE =====
        class SmartLoader {
            constructor() {
                this.cacheManager = new SmartCacheManager();
                this.isInitialLoad = true;
                this.loadingIndicator = document.getElementById('smart-loading-indicator');
                this.loadingBar = document.getElementById('smart-loading-bar');
                this.cacheStatus = document.getElementById('cache-status');
            }
            
            async loadData() {
                this.showCacheStatus();
                
                if (this.cacheManager.hasValidCache()) {
                    console.log('Cargando desde cache...');
                    const cachedData = this.cacheManager.loadFromCache();
                    
                    if (cachedData && cachedData.allChannels && cachedData.categories) {
                        this.applyCachedData(cachedData);
                        this.updateInBackground();
                        return true;
                    }
                }
                
                console.log('Cargando desde Drive...');
                return await this.loadFromDrive();
            }
            
            applyCachedData(cachedData) {
                allChannels = cachedData.allChannels || [];
                categories = new Map(Object.entries(cachedData.categories || {}));
                allSeries = cachedData.allSeries || [];
                
                searchEngine = new SearchEngine(allChannels);
                
                renderCategories();
                renderChannels();
                
                console.log('Datos cargados desde cache:', {
                    canales: allChannels.length,
                    categorias: categories.size,
                    series: allSeries.length
                });
            }
            
            async loadFromDrive() {
                this.showLoadingIndicator();
                
                try {
                    const result = await loadFromGoogleDriveSilent();
                    const content = result.content;
                    
                    if (!content || !content.includes('#EXTM3U')) {
                        throw new Error('Contenido no válido');
                    }
                    
                    parseM3U(content);
                    
                    const cacheData = {
                        allChannels: allChannels,
                        categories: Object.fromEntries(categories),
                        allSeries: allSeries,
                        timestamp: Date.now()
                    };
                    
                    this.cacheManager.saveToCache(cacheData);
                    
                    console.log('Datos cargados desde Drive y guardados en cache');
                    return true;
                    
                } catch (error) {
                    console.error('Error cargando desde Drive:', error);
                    
                    const cachedData = this.cacheManager.loadFromCache();
                    if (cachedData) {
                        console.log('Usando cache expirado como respaldo');
                        this.applyCachedData(cachedData);
                        return true;
                    }
                    
                    return false;
                } finally {
                    this.hideLoadingIndicator();
                    this.showCacheStatus();
                }
            }
            
            async updateInBackground() {
                if (this.cacheManager.isUpdating) return;
                
                this.cacheManager.isUpdating = true;
                console.log('Actualizando datos en segundo plano...');
                
                try {
                    const result = await loadFromGoogleDriveSilent();
                    const content = result.content;
                    
                    if (content && content.includes('#EXTM3U')) {
                        const oldChannels = [...allChannels];
                        parseM3U(content);
                        
                        if (this.hasSignificantChanges(oldChannels, allChannels)) {
                            const cacheData = {
                                allChannels: allChannels,
                                categories: Object.fromEntries(categories),
                                allSeries: allSeries,
                                timestamp: Date.now()
                            };
                            
                            this.cacheManager.saveToCache(cacheData);
                            console.log('Datos actualizados en segundo plano');
                        } else {
                            console.log('No hay cambios significativos, manteniendo cache actual');
                        }
                    }
                } catch (error) {
                    console.error('Error en actualización en segundo plano:', error);
                } finally {
                    this.cacheManager.isUpdating = false;
                    this.showCacheStatus();
                }
            }
            
            hasSignificantChanges(oldChannels, newChannels) {
                if (oldChannels.length !== newChannels.length) return true;
                
                const oldUrls = new Set(oldChannels.map(c => c.url));
                const newUrls = new Set(newChannels.map(c => c.url));
                
                if (oldUrls.size !== newUrls.size) return true;
                
                for (let url of oldUrls) {
                    if (!newUrls.has(url)) return true;
                }
                
                return false;
            }
            
            showLoadingIndicator() {
                if (this.loadingIndicator && this.loadingBar) {
                    this.loadingIndicator.style.display = 'block';
                    this.loadingBar.style.width = '30%';
                    
                    setTimeout(() => {
                        if (this.loadingBar) {
                            this.loadingBar.style.width = '70%';
                        }
                    }, 500);
                }
            }
            
            hideLoadingIndicator() {
                if (this.loadingIndicator && this.loadingBar) {
                    this.loadingBar.style.width = '100%';
                    setTimeout(() => {
                        this.loadingIndicator.style.display = 'none';
                        this.loadingBar.style.width = '0%';
                    }, 300);
                }
            }
            
            showCacheStatus() {
                if (!this.cacheStatus) return;
                
                const status = this.cacheManager.getCacheStatus();
                
                if (status.hasCache) {
                    this.cacheStatus.textContent = `✅ Cache: ${status.lastUpdate}`;
                    this.cacheStatus.style.display = 'block';
                    
                    setTimeout(() => {
                        this.cacheStatus.style.display = 'none';
                    }, 3000);
                } else if (status.isUpdating) {
                    this.cacheStatus.textContent = '🔄 Actualizando...';
                    this.cacheStatus.style.display = 'block';
                }
            }
        }

        // ===== INICIALIZACIÓN DEL SISTEMA INTELIGENTE =====
        const smartLoader = new SmartLoader();

        // ===== SISTEMA MEJORADO PARA ENLACES NUMÉRICOS =====
        const urlCache = new Map();

        function detectStreamType(url) {
            const urlStr = url.toLowerCase();
            
            if (urlStr.includes('.m3u8')) return 'hls';
            if (urlStr.includes('.mp4')) return 'mp4';
            if (urlStr.includes('.mkv')) return 'mkv';
            if (urlStr.includes('.avi')) return 'avi';
            if (urlStr.includes('.ts')) return 'ts';
            if (urlStr.match(/\/\d+$/)) return 'numeric_id';
            
            return 'unknown';
        }

        function generateUrlOptions(baseUrl, streamId) {
            return [
                baseUrl,
                `${baseUrl}.m3u8`,
                `${baseUrl}/index.m3u8`,
                `${baseUrl.replace(/\/[^\/]+$/, '')}/playlist.m3u8?id=${streamId}`,
                `${baseUrl.replace(/\/[^\/]+$/, '')}/hls/${streamId}/index.m3u8`,
                `${baseUrl.replace(/\/[^\/]+$/, '')}/live/${streamId}/index.m3u8`,
                `${baseUrl.replace(/\/[^\/]+$/, '')}/stream/${streamId}.m3u8`,
                `${baseUrl.replace(/\/[^\/]+$/, '')}/chunklist_${streamId}.m3u8`,
                `${baseUrl}?format=m3u8`,
                `${baseUrl}?type=hls`
            ];
        }

        function transformUrlToM3u8(url) {
            if (!url || typeof url !== 'string') return url;
            
            if (urlCache.has(url)) {
                const cached = urlCache.get(url);
                return typeof cached === 'object' ? cached.main : cached;
            }
            
            try {
                const urlLower = url.toLowerCase();
                let transformedUrl = url;
                
                if (urlLower.includes('.m3u8') || urlLower.includes('.mp4') || 
                    urlLower.includes('.mkv') || urlLower.includes('.avi')) {
                    urlCache.set(url, transformedUrl);
                    return transformedUrl;
                }
                
                if (url.match(/\/\d+$/) && !urlLower.includes('.m3u8')) {
                    const baseUrl = url.replace(/\/\d+$/, '');
                    const streamId = url.match(/\/(\d+)$/)[1];
                    
                    const possibleUrls = generateUrlOptions(url, streamId);
                    transformedUrl = possibleUrls[0];
                    
                    urlCache.set(url, { main: transformedUrl, alternatives: possibleUrls });
                    
                } else if (urlLower.includes('.ts') && !urlLower.includes('.m3u8')) {
                    transformedUrl = url.replace(/\.ts$/i, '.m3u8');
                } else if (urlLower.includes('/chunklist')) {
                    transformedUrl = url.replace('/chunklist', '/index');
                }
                
                urlCache.set(url, transformedUrl);
                return transformedUrl;
                
            } catch (e) {
                return url;
            }
        }

        // ===== SISTEMA DE BÚSQUEDA GLOBAL Y OPTIMIZADO =====
        class SearchEngine {
            constructor(channels) {
                this.channels = channels;
                this.index = this.buildIndex();
                this.debounceTimer = null;
            }
            
            buildIndex() {
                const index = {};
                this.channels.forEach((channel, idx) => {
                    const terms = this.extractSearchTerms(channel);
                    terms.forEach(term => {
                        if (!index[term]) index[term] = [];
                        index[term].push(idx);
                    });
                });
                return index;
            }
            
            extractSearchTerms(channel) {
                const terms = [];
                
                const nameTerms = channel.name.toLowerCase()
                    .split(/[^a-z0-9áéíóúñ]+/)
                    .filter(term => term.length > 2);
                terms.push(...nameTerms);
                
                const groupTerms = channel.group.toLowerCase()
                    .split(/[^a-z0-9áéíóúñ]+/)
                    .filter(term => term.length > 2);
                terms.push(...groupTerms);
                
                if (channel.seriesInfo) {
                    const seriesTerms = channel.seriesInfo.seriesName.toLowerCase()
                        .split(/[^a-z0-9áéíóúñ]+/)
                        .filter(term => term.length > 2);
                    terms.push(...seriesTerms);
                }
                
                return [...new Set(terms)];
            }
            
            search(query, options = {}) {
                if (!query || query.length < 2) return [];
                
                const queryTerms = query.toLowerCase()
                    .split(/[^a-z0-9áéíóúñ]+/)
                    .filter(term => term.length > 1);
                
                if (queryTerms.length === 0) return [];
                
                const scoredResults = this.channels.map((channel, idx) => {
                    let score = 0;
                    
                    const nameLower = channel.name.toLowerCase();
                    if (nameLower.includes(query.toLowerCase())) {
                        score += 100;
                    }
                    
                    queryTerms.forEach(term => {
                        if (nameLower.includes(term)) score += 10;
                        if (channel.group.toLowerCase().includes(term)) score += 5;
                        if (channel.seriesInfo && channel.seriesInfo.seriesName.toLowerCase().includes(term)) {
                            score += 8;
                        }
                    });
                    
                    return { channel, score, idx };
                }).filter(result => result.score > 0)
                  .sort((a, b) => b.score - a.score);
                
                const limit = options.limit || 100;
                return scoredResults.slice(0, limit).map(result => result.channel);
            }
            
            debouncedSearch(query, callback, delay = 300) {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    const results = this.search(query);
                    callback(results);
                }, delay);
            }
            
            updateChannels(newChannels) {
                this.channels = newChannels;
                this.index = this.buildIndex();
            }
        }

        // ===== SISTEMA DE CARGA PROGRESIVA =====
        class ChannelRenderer {
            constructor() {
                this.batchSize = 30;
                this.currentBatch = 0;
                this.isRendering = false;
            }
            
            renderChannelsBatch(channels, container, isSpecialCategory, startIndex = 0) {
                if (this.isRendering) return;
                this.isRendering = true;
                
                const endIndex = Math.min(startIndex + this.batchSize, channels.length);
                const fragment = document.createDocumentFragment();
                
                for (let i = startIndex; i < endIndex; i++) {
                    const channelElement = this.createChannelElement(channels[i], isSpecialCategory);
                    fragment.appendChild(channelElement);
                }
                
                container.appendChild(fragment);
                
                if (endIndex < channels.length) {
                    requestAnimationFrame(() => {
                        this.isRendering = false;
                        this.renderChannelsBatch(channels, container, isSpecialCategory, endIndex);
                    });
                } else {
                    this.isRendering = false;
                }
            }
            
            createChannelElement(channel, isSpecialCategory) {
                let channelElement;
                
                if (isSpecialCategory) {
                    channelElement = document.createElement('div');
                    channelElement.className = 'special-channel-card';
                    
                    const isFav = favorites.includes(channel.url);
                    const favClass = isFav ? '' : 'inactive';
                    
                    channelElement.innerHTML = `
                        <div class="favorite-star ${favClass}" data-url="${channel.url}">${isFav ? '★' : '☆'}</div>
                        <img src="${channel.logo || 'https://via.placeholder.com/300x450/0F3460/00FFAB?text=Poster'}" alt="${channel.name}" loading="lazy">
                        <div class="special-channel-name">${channel.name}</div>
                    `;
                } else {
                    channelElement = document.createElement('div');
                    channelElement.className = 'channel-card';
                    
                    const isFav = favorites.includes(channel.url);
                    const favClass = isFav ? '' : 'inactive';
                    
                    let seriesInfoHTML = '';
                    if (channel.seriesInfo && channel.seriesInfo.isSeries) {
                        const progress = getSeriesProgress(channel.seriesInfo.seriesName, channel.seriesInfo.season, channel.seriesInfo.episode);
                        const progressPercent = progress * 100;
                        
                        seriesInfoHTML = `
                            <div class="series-info">
                                <div>T${channel.seriesInfo.season} E${channel.seriesInfo.episode}</div>
                                <div class="series-progress">
                                    <div class="series-progress-bar" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
                    }
                    
                    channelElement.innerHTML = `
                        <div class="favorite-star ${favClass}" data-url="${channel.url}">${isFav ? '★' : '☆'}</div>
                        <img src="${channel.logo || 'https://via.placeholder.com/50x50/0F3460/00FFAB?text=TV'}" alt="${channel.name}" loading="lazy">
                        <div class="channel-name">${channel.name}</div>
                        ${seriesInfoHTML}
                    `;
                }
                
                if (channel.url === currentPlayingChannelUrl) {
                    channelElement.classList.add('active');
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'playing-indicator';
                    channelElement.style.position = 'relative';
                    channelElement.appendChild(indicator);
                }
                
                this.attachChannelEventListeners(channelElement, channel);
                
                return channelElement;
            }
            
            attachChannelEventListeners(element, channel) {
                const favStar = element.querySelector('.favorite-star');
                favStar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(channel.url);
                    renderCategories();
                    renderChannels();
                });
                
                element.addEventListener('click', () => {
                    if (channel.seriesInfo && channel.seriesInfo.isSeries) {
                        playSeries(channel);
                    } else {
                        playChannel(channel);
                    }
                });
            }
            
            clearContainer(container) {
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
            }
            
            createSearchResultElement(channel) {
                const resultElement = document.createElement('div');
                resultElement.className = 'search-result-item';
                
                const isSeries = channel.seriesInfo && channel.seriesInfo.isSeries;
                const seriesInfo = isSeries ? 
                    `S${channel.seriesInfo.season} E${channel.seriesInfo.episode}` : '';
                
                resultElement.innerHTML = `
                    <div class="search-result-name">${channel.name}</div>
                    <div class="search-result-category">${channel.group} ${seriesInfo}</div>
                `;
                
                resultElement.addEventListener('click', () => {
                    closeGlobalSearchModal();
                    
                    if (isSeries) {
                        playSeries(channel);
                    } else {
                        playChannel(channel);
                    }
                });
                
                return resultElement;
            }
        }

        // ===== INICIALIZACIÓN DE SISTEMAS OPTIMIZADOS =====
        let searchEngine = null;
        let channelRenderer = new ChannelRenderer();
        let videoPlayer = null;

        // Global variables
        const playerView = document.getElementById('player-view');
        const mainContent = document.getElementById('main-content');
        const channelPlayer = document.getElementById('channel-player');
        const playerSearchInput = document.getElementById('player-search-input');
        const backToMain = document.getElementById('back-to-main');
        const globalSearchBtn = document.getElementById('global-search-btn');
        // EL BOTÓN DE ESTADÍSTICAS ESTÁ OCULTO PERO EXISTE
        const techStatsBtn = document.getElementById('tech-stats-btn');
        const seriesControls = document.getElementById('series-controls');
        const seriesInfoDisplay = document.getElementById('series-info-display');
        const autoPlayToggle = document.getElementById('auto-play-toggle');
        
        const seasonsContainer = document.getElementById('seasons-container');
        const seasonsScroll = document.getElementById('seasons-scroll');
        const episodesContainer = document.getElementById('episodes-container');
        const episodesScroll = document.getElementById('episodes-scroll');
        const otherSeriesContainer = document.getElementById('other-series-container');
        const otherSeriesScroll = document.getElementById('other-series-scroll');
        
        const playerChannelsGrid = document.getElementById('player-channels-grid');
        const categoriesPanel = document.getElementById('categories-panel');
        const channelsGridContainer = document.getElementById('channels-grid-container');
        const searchInput = document.getElementById('search-input');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const fileInput = document.getElementById('file-input');

        const globalSearchModal = document.getElementById('global-search-modal');
        const globalSearchInput = document.getElementById('global-search-input');
        const globalSearchResults = document.getElementById('global-search-results');
        const closeGlobalSearchBtn = document.getElementById('close-global-search');

        let allChannels = [];
        let categories = new Map();
        let favorites = JSON.parse(localStorage.getItem('iptv_favorites') || '[]');
        let currentCategory = null;
        let showingFavorites = false;
        let searchActive = false;
        let seriesProgress = JSON.parse(localStorage.getItem('series_progress') || '{}');

        let currentSeriesEpisodes = [];
        let currentSeason = 1;
        let currentEpisodeIndex = 0;
        let currentSeriesName = '';
        let autoPlayEnabled = true;
        let currentPlayingChannel = null;
        let currentPlayingChannelUrl = null;
        let allSeries = [];

        // ===== CONFIGURACIÓN DE GOOGLE DRIVE OCULTA =====
        const DRIVE_FILE_ID = "14WdnCTQeV8y594jZQIhVbxHkaxfxWC18";
        const PROXIES = [
            {
                name: "CorsProxy",
                url: (id) => `https://corsproxy.io/?${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${id}`)}`,
                timeout: 5000
            },
            {
                name: "AllOrigins", 
                url: (id) => `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?export=download&id=${id}`)}`,
                timeout: 5000
            },
            {
                name: "ThingProxy",
                url: (id) => `https://thingproxy.freeboard.io/fetch/https://drive.google.com/uc?export=download&id=${id}`,
                timeout: 4000
            }
        ];

        async function loadFromGoogleDriveSilent() {
            const promises = PROXIES.map(proxy => 
                Promise.race([
                    fetch(proxy.url(DRIVE_FILE_ID), {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/plain, application/x-mpegURL',
                            'Cache-Control': 'no-cache'
                        }
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('timeout')), proxy.timeout)
                    )
                ])
                .then(async response => {
                    if (!response.ok) throw new Error('HTTP error');
                    const content = await response.text();
                    if (!content || !content.includes('#EXTM3U')) {
                        throw new Error('Invalid content');
                    }
                    return { content, proxy: proxy.name };
                })
                .catch(error => {
                    throw error;
                })
            );

            return Promise.any(promises);
        }

        function parseM3U(data) {
            allChannels = [];
            categories.clear();
            allSeries = [];
            
            const lines = data.split(/\r?\n/);
            let channel = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF')) {
                    const groupMatch = line.match(/group-title="([^"]+)"/i);
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/i);
                    const nameMatch = line.split(',')[1] || 'Sin nombre';
                    channel = {
                        group: groupMatch ? groupMatch[1] : 'Otros',
                        logo: logoMatch ? logoMatch[1] : '',
                        name: nameMatch,
                        url: ''
                    };
                    
                    channel.seriesInfo = extractSeriesInfo(channel);
                } else if (line && !line.startsWith('#')) {
                    if (channel) {
                        channel.url = line;
                        allChannels.push(channel);
                        
                        if (!categories.has(channel.group)) {
                            categories.set(channel.group, []);
                        }
                        categories.get(channel.group).push(channel);
                        
                        if (channel.seriesInfo && channel.seriesInfo.isSeries) {
                            const existingSeries = allSeries.find(s => s.name === channel.seriesInfo.seriesName);
                            if (!existingSeries) {
                                allSeries.push({
                                    name: channel.seriesInfo.seriesName,
                                    episodes: [channel],
                                    group: channel.group,
                                    totalEpisodes: 1,
                                    totalSeasons: 1
                                });
                            } else {
                                existingSeries.episodes.push(channel);
                                existingSeries.totalEpisodes = existingSeries.episodes.length;
                                const uniqueSeasons = [...new Set(existingSeries.episodes.map(ep => ep.seriesInfo.season))];
                                existingSeries.totalSeasons = uniqueSeasons.length;
                            }
                        }
                        
                        channel = null;
                    }
                }
            }
            
            searchEngine = new SearchEngine(allChannels);
            
            renderCategories();
            renderChannels();
        }

        function extractSeriesInfo(item) {
            const title = item.name.toLowerCase();
            
            const isSeries = /s\d+\s*e\d+/i.test(title) || 
                            /temporada\s*\d+/i.test(title) || 
                            /season\s*\d+/i.test(title) || 
                            /cap[íi]tulo\s*\d+/i.test(title) || 
                            /episodio\s*\d+/i.test(title) ||
                            /chapter\s*\d+/i.test(title) ||
                            item.group?.toLowerCase().includes('serie');
            
            if (!isSeries) return null;
            
            const seasonMatch = title.match(/s(\d+)/i) || 
                               title.match(/temporada\s*(\d+)/i) || 
                               title.match(/season\s*(\d+)/i);
            const season = seasonMatch ? parseInt(seasonMatch[1]) : 1;
            
            const episodeMatch = title.match(/e(\d+)/i) || 
                                title.match(/cap[íi]tulo\s*(\d+)/i) || 
                                title.match(/episodio\s*(\d+)/i) || 
                                title.match(/chapter\s*(\d+)/i);
            const episode = episodeMatch ? parseInt(episodeMatch[1]) : 1;
            
            const seriesName = item.name
                .replace(/\s*s\d+\s*e\d+/i, '')
                .replace(/\s*temporada\s*\d+/i, '')
                .replace(/\s*cap[íi]tulo\s*\d+/i, '')
                .replace(/\s*episodio\s*\d+/i, '')
                .trim();
            
            return {
                seriesName,
                season,
                episode,
                isSeries: true
            };
        }

        function renderCategories() {
            categoriesPanel.innerHTML = '';
            
            if (favorites.length > 0) {
                const favItem = document.createElement('div');
                favItem.className = `category-item ${showingFavorites ? 'active' : ''}`;
                favItem.innerHTML = `
                    <span class="category-name">⭐ Favoritos</span>
                    <span class="category-count">${favorites.length}</span>
                `;
                
                favItem.addEventListener('click', () => {
                    showingFavorites = true;
                    currentCategory = null;
                    searchActive = false;
                    searchInput.value = '';
                    renderCategories();
                    renderChannels();
                });
                
                categoriesPanel.appendChild(favItem);
            }
            
            for (const [categoryName, channels] of categories) {
                const categoryItem = document.createElement('div');
                categoryItem.className = `category-item ${categoryName === currentCategory ? 'active' : ''}`;
                categoryItem.innerHTML = `
                    <span class="category-name">${categoryName}</span>
                    <span class="category-count">${channels.length}</span>
                `;
                
                categoryItem.addEventListener('click', () => {
                    showingFavorites = false;
                    currentCategory = categoryName;
                    searchActive = false;
                    searchInput.value = '';
                    renderCategories();
                    renderChannels();
                });
                
                categoriesPanel.appendChild(categoryItem);
            }
            
            if (categories.size > 0 && !currentCategory && !showingFavorites) {
                currentCategory = [...categories.keys()][0];
                renderCategories();
            }
        }

        function renderChannels() {
            channelRenderer.clearContainer(channelsGridContainer);
            
            let channelsToShow = [];
            
            if (showingFavorites) {
                channelsToShow = allChannels.filter(channel => favorites.includes(channel.url));
            } else if (currentCategory && categories.has(currentCategory)) {
                channelsToShow = categories.get(currentCategory);
            } else if (searchActive) {
                const searchTerm = searchInput.value.toLowerCase();
                channelsToShow = searchEngine.search(searchTerm, { limit: 200 });
            }
            
            const isSpecialCategory = specialCategories.some(cat => 
                currentCategory && currentCategory.toLowerCase().includes(cat.toLowerCase())
            );
            
            const gridContainer = document.createElement('div');
            gridContainer.className = isSpecialCategory ? 'special-channels-grid' : 'channels-grid';
            channelsGridContainer.appendChild(gridContainer);
            
            if (channelsToShow.length > 0) {
                channelRenderer.renderChannelsBatch(channelsToShow, gridContainer, isSpecialCategory);
            }
        }

        function setupGlobalSearch() {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                
                if (query === '') {
                    searchActive = false;
                    renderCategories();
                    renderChannels();
                } else {
                    searchActive = true;
                    searchEngine.debouncedSearch(query, (results) => {
                        const gridContainer = channelsGridContainer.querySelector('.channels-grid, .special-channels-grid');
                        if (gridContainer) {
                            channelRenderer.clearContainer(gridContainer);
                            const isSpecialCategory = gridContainer.classList.contains('special-channels-grid');
                            channelRenderer.renderChannelsBatch(results, gridContainer, isSpecialCategory);
                        }
                    }, 200);
                }
            });
            
            playerSearchInput.addEventListener('input', () => {
                const query = playerSearchInput.value.trim();
                
                if (query === '') {
                    renderPlayerChannels();
                } else {
                    const results = searchEngine.search(query, { limit: 100 });
                    
                    channelRenderer.clearContainer(playerChannelsGrid);
                    const isSpecialCategory = specialCategories.some(cat => 
                        currentCategory && currentCategory.toLowerCase().includes(cat.toLowerCase())
                    );
                    channelRenderer.renderChannelsBatch(results, playerChannelsGrid, isSpecialCategory);
                }
            });
            
            globalSearchBtn.addEventListener('click', openGlobalSearchModal);
            
            globalSearchInput.addEventListener('input', () => {
                const query = globalSearchInput.value.trim();
                
                if (query === '') {
                    globalSearchResults.innerHTML = '<div class="search-result-item">Ingresa un término de búsqueda...</div>';
                } else {
                    searchEngine.debouncedSearch(query, (results) => {
                        channelRenderer.clearContainer(globalSearchResults);
                        
                        if (results.length === 0) {
                            globalSearchResults.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                        } else {
                            results.forEach(channel => {
                                const resultElement = channelRenderer.createSearchResultElement(channel);
                                globalSearchResults.appendChild(resultElement);
                            });
                        }
                    }, 300);
                }
            });
            
            // EL BOTÓN DE ESTADÍSTICAS ESTÁ OCULTO, NO SE CONFIGURA EVENT LISTENER
        }

        function openGlobalSearchModal() {
            globalSearchModal.style.display = 'flex';
            globalSearchInput.value = '';
            globalSearchInput.focus();
            globalSearchResults.innerHTML = '<div class="search-result-item">Ingresa un término de búsqueda...</div>';
        }

        function closeGlobalSearchModal() {
            globalSearchModal.style.display = 'none';
            globalSearchInput.value = '';
        }

        function toggleFavorite(url) {
            if (favorites.includes(url)) {
                favorites = favorites.filter(f => f !== url);
            } else {
                favorites.push(url);
            }
            localStorage.setItem('iptv_favorites', JSON.stringify(favorites));
        }

        function markChannelAsActive(channelUrl) {
            document.querySelectorAll('.channel-card, .special-channel-card').forEach(card => {
                const cardUrl = card.querySelector('.favorite-star')?.getAttribute('data-url');
                if (cardUrl === channelUrl) {
                    card.classList.add('active');
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'playing-indicator';
                    card.style.position = 'relative';
                    card.appendChild(indicator);
                }
            });
        }

        function playSeries(channel) {
            document.querySelectorAll('.channel-card.active, .special-channel-card.active').forEach(card => {
                card.classList.remove('active');
            });
            
            document.querySelectorAll('.playing-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            currentPlayingChannel = channel;
            currentPlayingChannelUrl = channel.url;
            
            if (videoPlayer) {
                videoPlayer.stop();
            }

            playerView.style.display = 'flex';
            mainContent.style.display = 'none';

            seriesControls.style.display = 'flex';
            currentSeriesName = channel.seriesInfo.seriesName;
            seriesInfoDisplay.textContent = `${currentSeriesName} S${channel.seriesInfo.season.toString().padStart(2, '0')} E${channel.seriesInfo.episode.toString().padStart(2, '0')}`;
            
            currentSeriesEpisodes = allChannels.filter(ch => 
                ch.seriesInfo && 
                ch.seriesInfo.isSeries && 
                ch.seriesInfo.seriesName === currentSeriesName
            );
            
            currentSeason = channel.seriesInfo.season || 1;
            const seasonEpisodes = currentSeriesEpisodes.filter(ep => ep.seriesInfo.season === currentSeason);
            currentEpisodeIndex = seasonEpisodes.findIndex(ep => ep.url === channel.url);
            
            const seasons = groupEpisodesBySeason(currentSeriesEpisodes);
            showSeasonSelector(seasons);
            
            showEpisodesForSeason(seasonEpisodes);
            
            showOtherSeries();
            
            renderPlayerChannelsWithSeries(currentSeriesEpisodes);

            markChannelAsActive(channel.url);

            videoPlayer.play(channel.url, channel);
        }

        function playChannel(channel) {
            document.querySelectorAll('.channel-card.active, .special-channel-card.active').forEach(card => {
                card.classList.remove('active');
            });
            
            document.querySelectorAll('.playing-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            currentPlayingChannel = channel;
            currentPlayingChannelUrl = channel.url;
            
            if (videoPlayer) {
                videoPlayer.stop();
            }

            playerView.style.display = 'flex';
            mainContent.style.display = 'none';

            seriesControls.style.display = 'none';
            seasonsContainer.style.display = 'none';
            episodesContainer.style.display = 'none';
            otherSeriesContainer.style.display = 'none';
            
            markChannelAsActive(channel.url);
            
            renderPlayerChannels();

            videoPlayer.play(channel.url, channel);
        }

        function renderPlayerChannelsWithSeries(episodes) {
            channelRenderer.clearContainer(playerChannelsGrid);
            
            const isSpecialCategory = specialCategories.some(cat => 
                currentCategory && currentCategory.toLowerCase().includes(cat.toLowerCase())
            );
            
            playerChannelsGrid.className = isSpecialCategory ? 'special-channels-grid' : 'channels-grid';
            
            if (episodes.length > 0) {
                channelRenderer.renderChannelsBatch(episodes, playerChannelsGrid, isSpecialCategory);
            }
        }

        function showEpisodesForSeason(episodes) {
            episodesScroll.innerHTML = '';
            episodesContainer.style.display = 'flex';

            episodes.forEach((episode, index) => {
                const isCurrent = episode.url === currentPlayingChannel.url;
                const episodeItem = document.createElement('div');
                episodeItem.className = `episode-item ${isCurrent ? 'current' : ''}`;
                episodeItem.textContent = `E${episode.seriesInfo?.episode || (index + 1)}`;
                episodeItem.title = episode.name;
                
                episodeItem.onclick = () => {
                    videoPlayer.play(episode.url, episode);
                    currentPlayingChannel = episode;
                    currentEpisodeIndex = index;
                    
                    seriesInfoDisplay.textContent = `${currentSeriesName} S${currentSeason.toString().padStart(2, '0')} E${episode.seriesInfo.episode.toString().padStart(2, '0')}`;
                    
                    document.querySelectorAll('.episode-item').forEach(item => item.classList.remove('current'));
                    episodeItem.classList.add('current');
                    
                    markChannelAsActive(episode.url);
                };
                episodesScroll.appendChild(episodeItem);
            });
        }

        function showOtherSeries() {
            otherSeriesScroll.innerHTML = '';
            otherSeriesContainer.style.display = 'flex';
            
            let otherSeries = allSeries.filter(series => 
                series.name !== currentSeriesName
            );
            
            otherSeries.sort((a, b) => b.totalEpisodes - a.totalEpisodes);
            
            otherSeries = otherSeries.slice(0, 12);
            
            if (otherSeries.length === 0) {
                otherSeriesContainer.style.display = 'none';
                return;
            }
            
            otherSeries.forEach(series => {
                const seriesItem = document.createElement('div');
                seriesItem.className = 'other-series-item';
                
                seriesItem.innerHTML = `
                    <div class="other-series-name">${series.name}</div>
                    <div class="other-series-info">${series.totalSeasons} Temp • ${series.totalEpisodes} Eps</div>
                `;
                
                seriesItem.addEventListener('click', () => {
                    const firstEpisode = series.episodes[0];
                    
                    currentSeriesName = series.name;
                    currentSeriesEpisodes = series.episodes;
                    currentSeason = firstEpisode.seriesInfo.season || 1;
                    
                    const seasons = groupEpisodesBySeason(currentSeriesEpisodes);
                    showSeasonSelector(seasons);
                    
                    const seasonEpisodes = seasons[currentSeason] || [];
                    showEpisodesForSeason(seasonEpisodes);
                    
                    renderPlayerChannelsWithSeries(currentSeriesEpisodes);
                    
                    playSeries(firstEpisode);
                });
                
                otherSeriesScroll.appendChild(seriesItem);
            });
        }

        function showSeasonSelector(seasons) {
            seasonsScroll.innerHTML = '';
            seasonsContainer.style.display = 'flex';

            Object.keys(seasons).sort().forEach(seasonNum => {
                const seasonBtn = document.createElement('div');
                seasonBtn.className = `season-btn ${parseInt(seasonNum) === currentSeason ? 'active' : ''}`;
                seasonBtn.textContent = `Temporada ${seasonNum}`;
                seasonBtn.title = `${seasons[seasonNum].length} episodios`;
                
                seasonBtn.addEventListener('click', () => {
                    currentSeason = parseInt(seasonNum);
                    showEpisodesForSeason(seasons[currentSeason]);
                    
                    document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
                    seasonBtn.classList.add('active');
                });
                
                seasonsScroll.appendChild(seasonBtn);
            });
        }

        function renderPlayerChannels() {
            channelRenderer.clearContainer(playerChannelsGrid);
            
            let channelsToShow = [];
            
            if (currentCategory && categories.has(currentCategory)) {
                channelsToShow = categories.get(currentCategory);
            } else if (showingFavorites) {
                channelsToShow = allChannels.filter(channel => favorites.includes(channel.url));
            }
            
            const searchTerm = playerSearchInput.value.toLowerCase();
            if (searchTerm) {
                channelsToShow = searchEngine.search(searchTerm, { limit: 100 });
            }
            
            const isSpecialCategory = specialCategories.some(cat => 
                currentCategory && currentCategory.toLowerCase().includes(cat.toLowerCase())
            );
            
            playerChannelsGrid.className = isSpecialCategory ? 'special-channels-grid' : 'channels-grid';
            
            if (channelsToShow.length > 0) {
                channelRenderer.renderChannelsBatch(channelsToShow, playerChannelsGrid, isSpecialCategory);
            }
        }

        function groupEpisodesBySeason(episodes) {
            const seasons = {};
            episodes.forEach(ep => {
                const seasonNum = ep.seriesInfo?.season || 1;
                seasons[seasonNum] = seasons[seasonNum] || [];
                seasons[seasonNum].push(ep);
            });
            Object.keys(seasons).forEach(season => {
                seasons[season].sort((a, b) => (a.seriesInfo?.episode || 0) - (b.seriesInfo?.episode || 0));
            });
            return seasons;
        }

        function findNextEpisode(currentChannel) {
            if (!autoPlayEnabled || !currentSeriesEpisodes.length) return null;
            
            const seasons = groupEpisodesBySeason(currentSeriesEpisodes);
            const currentSeasonEpisodes = seasons[currentSeason] || [];
            
            if (currentEpisodeIndex !== -1 && currentEpisodeIndex < currentSeasonEpisodes.length - 1) {
                return currentSeasonEpisodes[currentEpisodeIndex + 1];
            } else {
                const seasonKeys = Object.keys(seasons).map(Number).sort((a, b) => a - b);
                const currentSeasonIndex = seasonKeys.indexOf(currentSeason);
                
                if (currentSeasonIndex !== -1 && currentSeasonIndex < seasonKeys.length - 1) {
                    const nextSeason = seasonKeys[currentSeasonIndex + 1];
                    if (seasons[nextSeason] && seasons[nextSeason].length > 0) {
                        return seasons[nextSeason][0];
                    }
                }
            }
            
            return null;
        }

        function showMainMenu() {
            if (videoPlayer) {
                videoPlayer.stop();
            }
            
            document.querySelectorAll('.channel-card.active, .special-channel-card.active').forEach(card => {
                card.classList.remove('active');
            });
            
            document.querySelectorAll('.playing-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            currentPlayingChannel = null;
            currentPlayingChannelUrl = null;
            
            playerView.style.display = 'none';
            mainContent.style.display = 'flex';
            seriesControls.style.display = 'none';
        }

        function getSeriesProgress(seriesName, season, episode) {
            if (seriesProgress[seriesName] && 
                seriesProgress[seriesName][season] && 
                seriesProgress[seriesName][season][episode]) {
                return seriesProgress[seriesName][season][episode];
            }
            return 0;
        }

        function updateSeriesProgress(seriesName, season, episode, progress = 1) {
            if (!seriesProgress[seriesName]) {
                seriesProgress[seriesName] = {};
            }
            
            if (!seriesProgress[seriesName][season]) {
                seriesProgress[seriesName][season] = {};
            }
            
            seriesProgress[seriesName][season][episode] = progress;
            localStorage.setItem('series_progress', JSON.stringify(seriesProgress));
        }

        // Event listeners
        settingsBtn.addEventListener('click', () => {
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });

        document.getElementById('show-favorites').addEventListener('click', () => {
            showingFavorites = true;
            currentCategory = null;
            searchActive = false;
            searchInput.value = '';
            renderCategories();
            renderChannels();
            settingsMenu.style.display = 'none';
        });

        document.getElementById('refresh-list').addEventListener('click', () => {
            smartLoader.loadFromDrive();
            settingsMenu.style.display = 'none';
        });

        document.getElementById('load-m3u').addEventListener('click', () => {
            fileInput.click();
            settingsMenu.style.display = 'none';
        });

        document.getElementById('clear-cache').addEventListener('click', () => {
            smartLoader.cacheManager.clearCache();
            settingsMenu.style.display = 'none';
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            settingsMenu.style.display = 'none';
        });

        backToMain.addEventListener('click', showMainMenu);

        autoPlayToggle.addEventListener('change', function() {
            autoPlayEnabled = this.checked;
            localStorage.setItem('autoPlayEnabled', autoPlayEnabled);
            if (videoPlayer) {
                videoPlayer.setAutoPlay(autoPlayEnabled);
            }
        });

        closeGlobalSearchBtn.addEventListener('click', closeGlobalSearchModal);

        globalSearchModal.addEventListener('click', (e) => {
            if (e.target === globalSearchModal) {
                closeGlobalSearchModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && globalSearchModal.style.display === 'flex') {
                closeGlobalSearchModal();
            }
        });

        function loadAutoPlayPreference() {
            const saved = localStorage.getItem('autoPlayEnabled');
            autoPlayEnabled = saved !== null ? saved === 'true' : true;
            autoPlayToggle.checked = autoPlayEnabled;
        }

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const file = this.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    parseM3U(e.target.result);
                    
                    const cacheData = {
                        allChannels: allChannels,
                        categories: Object.fromEntries(categories),
                        allSeries: allSeries,
                        timestamp: Date.now()
                    };
                    smartLoader.cacheManager.saveToCache(cacheData);
                };
                
                reader.readAsText(file);
            }
        });

        document.addEventListener('click', (e) => {
            if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
                settingsMenu.style.display = 'none';
            }
        });

        function initVideoPlayer() {
            const videoElement = document.getElementById('channel-player');
            videoPlayer = new SmartVideoPlayer(videoElement);
            videoPlayer.setAutoPlay(autoPlayEnabled);
        }

        const specialCategories = [
            'películas', 'película', 'serie', 'movies', 'series', 'drama',
            'acción', 'action', 'terror', 'horror', 'anime',
            'animación', 'dorama', 'doramas', 'netflix',
            'infantil', 'dramas', 'telenovela', 'child', 'narcos',
            'narcoseries', 'infantil', 'kids', 'vado', 'comedia'
        ];

        async function init() {
            await smartLoader.loadData();
            
            loadAutoPlayPreference();
            setupGlobalSearch();
            initVideoPlayer();
        }

        init();
    </script>
</body>
</html>
        <style>
            /* Tus estilos CSS aquí */
            .tu-aplicacion { ... }
        </style>
        
        <div class="app-container">
            <!-- Tu interfaz completa con canales, categorías, reproductor -->
        </div>
        
        <script>
            // Tu JavaScript aquí
            function initApp() { ... }
        </script>
        -->
        
    </div>
    <!-- ================================================== -->

    <script>
        // SCRIPT DEL EFECTO DE PRESENTACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                const size = Math.random() * 20 + 5;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.animationDelay = `${Math.random() * 15}s`;
                
                const duration = Math.random() * 10 + 10;
                particle.style.animationDuration = `${duration}s`;
                
                particlesContainer.appendChild(particle);
            }
            
            // Simular progreso de carga
            const progressBar = document.getElementById('loading-progress');
            const loadingText = document.getElementById('loading-text');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = `${progress}%`;
                
                if (progress < 30) {
                    loadingText.textContent = "Cargando contenido...";
                } else if (progress < 60) {
                    loadingText.textContent = "Optimizando calidad de video...";
                } else if (progress < 90) {
                    loadingText.textContent = "Preparando interfaz...";
                } else {
                    loadingText.textContent = "¡Listo! Iniciando TVision Max...";
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Transición a la aplicación real
                    setTimeout(() => {
                        // Ocultar efecto de presentación
                        document.getElementById('splash-container').style.opacity = '0';
                        document.getElementById('particles').style.opacity = '0';
                        document.querySelector('.glow').style.opacity = '0';
                        
                        // Mostrar aplicación después de la animación
                        setTimeout(() => {
                            document.getElementById('splash-container').style.display = 'none';
                            document.getElementById('particles').style.display = 'none';
                            document.querySelector('.glow').style.display = 'none';
                            
                            // ==================================================
                            // MOSTRAR TU APLICACIÓN
                            // ==================================================
                            document.getElementById('app-container').style.display = 'block';
                            
                            // Cambiar el fondo al tema de la aplicación
                            document.body.style.background = '#000000';
                            document.body.style.animation = 'none';
                            
                            // ==================================================
                            // INICIALIZAR TU APLICACIÓN
                            // ==================================================
                            if (typeof initApp === 'function') {
                                initApp();
                            }
                            // ==================================================
                        }, 1000);
                    }, 1000);
                }
            }, 300);
        });

        // ==================================================
        // AQUÍ DEBES MOVER EL JAVASCRIPT DE TU APLICACIÓN
        // ==================================================
        /*
        function initApp() {
            // PEGA AQUÍ TODO EL CÓDIGO JAVASCRIPT DE TU APLICACIÓN:
            // - Variables globales
            // - Clases (SmartVideoPlayer, SmartCacheManager, etc.)
            // - Funciones (playChannel, renderChannels, etc.)
            // - Event listeners
            // - Inicialización
            
            // EJEMPLO:
            // let allChannels = [];
            // let categories = new Map();
            // function playChannel(channel) { ... }
            // document.addEventListener(...);
        }
        */
        // ==================================================
    </script>
</body>
</html>